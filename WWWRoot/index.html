<!DOCTYPE html>
<html>
<head>
    <title>Список пользователей</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <meta charset="utf-8" />
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: start;
            min-height: 100vh;
        }

        .container {
            background: white;
            margin-top: 50px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 500px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            outline: none;
            transition: 0.3s;
        }

            input[type="text"]:focus {
                border-color: #4a90e2;
            }

        .checkbox {
            display: flex;
            align-items: center;
        }

            .checkbox input {
                margin-right: 10px;
            }

        .buttons {
            margin-top: 15px;
            text-align: center;
        }

            .buttons button {
                padding: 10px 20px;
                margin: 5px;
                border: none;
                border-radius: 8px;
                background-color: #4a90e2;
                color: white;
                cursor: pointer;
                font-weight: bold;
                transition: background-color 0.3s;
            }

                .buttons button:hover {
                    background-color: #357ab8;
                }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f9f9f9;
            font-weight: bold;
        }

        td:last-child button {
            margin-right: 5px;
            padding: 5px 10px;
            font-size: 0.9em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
        }

        .edit-btn {
            background-color: #ff9800;
        }

        .delete-btn {
            background-color: #f44336;
        }

        .edit-btn:hover {
            background-color: #e68900;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Список пользователей</h1>
        <input type="hidden" id="Id" />
        <div class="form-group">
            <label for="Title">Пользователь</label>
            <input type="text" id="Title" placeholder="Например: Иванов иван" />
        </div>
        <div class="form-group checkbox">
            <input type="checkbox" id="IsCompleted" />
            <label for="IsCompleted">Есть мем</label>
        </div>
        <div class="buttons">
            <button id="saveBtn">Сохранить</button>
            <button id="resetBtn" style="background-color: #777;">Сбросить</button>

        </div>
        <table>
            <thead>
                <tr>
                    <th>Пользователь</th>
                    <th>Статус мема</th>
                    <th>Действия</th>
                    <th>Мем</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <div class="form-group">
            <label for="ImageFile">Выбрать изображение</label>
            <input type="file" id="ImageFile" accept="image/*" />
        </div>
        <div class="buttons">
            <button id="uploadImageBtn" style="background-color: #28a745;">Загрузить изображение</button>
        </div>
        <input type="hidden" id="ImageFileName" />
        <img id="imageView" style="display:none; margin-top: 20px; max-width: 100%; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);" alt="Аватар" />
    </div>


    <script>
        // Получение всех задач
        async function getToDos() {
            // отправляет запрос и получаем ответ
            const response = await fetch("/api/todo", {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            // если запрос прошел нормально
            if (response.ok === true) {
                // получаем данные
                const todo = await response.json();
                const rows = document.querySelector("tbody");
                // добавляем полученные элементы в таблицу
                todo.forEach(todo => rows.append(row(todo)));
            }
        }
        // Получение одной задачи
        async function getToDo(id) {
            const response = await fetch(`/api/todo/${id}`, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const todo = await response.json();
                document.getElementById("Id").value = todo.id;
                document.getElementById("Title").value = todo.title;
                document.getElementById("IsCompleted").checked = todo.isCompleted;
            }
            else {
                // если произошла ошибка, получаем сообщение об ошибке
                const error = await response.json();
                console.log(error.message); // и выводим его на консоль
            }
        }
        // Добавление
        async function createToDo(title, isCompleted, imageFileName) {
            const response = await fetch("api/todo", {
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    title: title,
                    isCompleted: isCompleted,
                    imageFileName: imageFileName
                })
            });
            if (response.ok === true) {
                const todo = await response.json();
                document.querySelector("tbody").append(row(todo));
            } else {
                const error = await response.json();
                console.log(error.message);
            }
        }

        async function editToDo(id, title, isCompleted, imageFileName) {
            const response = await fetch(`api/todo/${id}`, {
                method: "PUT",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: id,
                    title: title,
                    isCompleted: isCompleted,
                    imageFileName: imageFileName
                })
            });
            if (response.ok === true) {
                const tr = document.querySelector(`tr[data-rowid='${id}']`);
                if (tr) {
                    tr.replaceWith(row({ id, title, isCompleted: isCompleted, imageFileName }));
                }
            } else {
                const error = await response.json();
                console.log(error.message);
            }
        }
        // Удаление пользователя
        async function deleteToDo(id) {
            const response = await fetch(`/api/todo/${id}`, {
                method: "DELETE",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const tr = document.querySelector(`tr[data-rowid='${id}']`);
                if (tr) tr.remove();
            }
            else {
                const error = await response.json();
                console.log(error.message);
            }
        }

        async function getImage(fileName) {
            const image = document.getElementById("imageView");
            if (!fileName) {
                console.log("Имя файла не указано");
                return;
            }

            const response = await fetch(`/api/image/${fileName}`);

            if (response.ok) {
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob); 

                image.src = imageUrl;
                image.style.display = "block";
            } else {
                console.log("Ошибка загрузки изображения");
                image.style.display = "none";
            }
        }

        async function uploadImage() {
            const fileInput = document.getElementById("ImageFile");
            if (fileInput.files.length === 0) {
                alert("Выберите файл для загрузки");
                return null;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append("file", file);

            const response = await fetch("/api/image/upload", {
                method: "POST",
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                alert("Изображение загружено: " + result.fileName);
                return result.fileName; // возвращаем имя файла
            } else {
                alert("Ошибка загрузки изображения");
                return null;
            }
        }

        document.getElementById("uploadImageBtn").addEventListener("click", async (e) => {
            e.preventDefault();
            const fileName = await uploadImage();
            if (fileName) {
                // Можно сразу записать в скрытое поле или переменную для последующего сохранения
                document.getElementById("ImageFileName").value = fileName;
            }
        });

        function reset() {
            document.getElementById("Id").value = "";
            document.getElementById("Title").value = "";
            document.getElementById("IsCompleted").checked = false;
            document.getElementById("ImageFileName").value = "";
            document.getElementById("ImageFile").value = "";
            document.getElementById("imageView").style.display = "none";

        }
        // создание строки для таблицы
        function row(todo) {
            console.log(todo);
            const tr = document.createElement("tr");
            tr.setAttribute("data-rowid", todo.id);

            const titleTd = document.createElement("td");
            titleTd.append(todo.title);
            tr.append(titleTd);

            const isCompletedTd = document.createElement("td");
            isCompletedTd.append(todo.isCompleted ? "Да" : "Нет");
            tr.append(isCompletedTd);

            const linksTd = document.createElement("td");

            const editLink = document.createElement("button");
            editLink.append("Изменить");
            editLink.addEventListener("click", async () => await getToDo(todo.id));
            linksTd.append(editLink);

            const removeLink = document.createElement("button");
            removeLink.append("Удалить");
            removeLink.addEventListener("click", async () => await deleteToDo(todo.id));

            linksTd.append(removeLink);
            tr.appendChild(linksTd);

            const Memtd = document.createElement("td");

            const avatarButton = document.createElement("button");
            avatarButton.append("Посмотреть аватар");
            avatarButton.addEventListener("click", async () => await getImage(todo.imageFileName));
            Memtd.append(avatarButton);
            tr.appendChild(Memtd);
            return tr;
        }
        // сброс значений формы
        document.getElementById("resetBtn").addEventListener("click", () => reset());

        // отправка формы
        document.getElementById("saveBtn").addEventListener("click", async () => {

            const Id = document.getElementById("Id").value;
            const Title = document.getElementById("Title").value;
            const IsCompleted = document.getElementById("IsCompleted").checked;
            const ImageFileName = document.getElementById("ImageFileName").value;

            if (Id === "")
                await createToDo(Title, IsCompleted, ImageFileName);
            else
                await editToDo(Id, Title, IsCompleted, ImageFileName);

            reset();
        });

        // загрузка пользователей
        getToDos();
    </script>
</body>
</html>